<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.zerock.mapper.BoardMapper">

    <insert id="create">
        insert into tbl_board (title, content, writer)
        values(#{title}, #{content}, #{writer})
    </insert>
    <!--boardMapper.xml의 각 SQL 문의 id 속성 값은 BoardDAO 인터페이스와 동일하게 설정해주어서 혼란을 피하는 것이 좋음.-->

    <!-- boardMapper.xml 에 'replycnt'칼럼을 select 쿼리문에 추가 안해서
어느 한 게시물(readPage)들어가면 그 게시물의 전체 댓글수가 안 보여졌음요. -->
    <select id="read" resultType="org.zerock.domain.BoardVO">
        select
        bno, title, content, writer, regdate, viewcnt, replycnt
        from
        tbl_board
        where bno = #{bno}
    </select>

    <update id="update">
        update tbl_board set title =#{title}, content =#{content}
        where bno = #{bno}
    </update>

    <delete id="delete">
        delete from tbl_board where bno = #{bno}
    </delete>

    <select id="listAll" resultType="org.zerock.domain.BoardVO">
        <![CDATA[
         select
           bno, title, content, writer, regdate, viewcnt
         from
           tbl_board
         where bno > 0
         order by bno desc, regdate desc

        ]]>
    </select>

    <!-- 여기에 'replycnt' select 에 추가 안 해서 readPage 들어가면 그 게시물의 전체 댓글수가 안 보여졌음. -->
    <select id="listPage" resultType="BoardVO">
        <![CDATA[

         select
           bno, title, content, writer, regdate, viewcnt, replycnt
         from
           tbl_board
         where bno > 0
         order by bno desc, regdate desc
         limit #{page}, 10

        ]]>
    </select>

    <!--<select id="listCriteria" resultType="BoardVO">-->
    <!--<![CDATA[-->
    <!---->
    <!--select-->
    <!--bno, title, content, writer, regdate, viewcnt-->
    <!--from-->
    <!--tbl_board-->
    <!--where bno > 0-->
    <!--order by bno desc, regdate desc-->
    <!--limit #{pageStart}, #{perPageNum}-->

    <!--]]>-->
    <!--</select>-->

    <select id="listCriteria" resultType="BoardVO">
        <![CDATA[
         select
           bno, title, content, writer, regdate, viewcnt, replycnt
         from
           tbl_board
         where bno > 0
         order by bno desc, regdate desc
         limit #{pageStart}, #{perPageNum}
        ]]>
    </select>


    <select id="countPaging" resultType="int">
        <![CDATA[
         select
           count(bno)
         from
           tbl_board
         where
           bno > 0
        ]]>
    </select>


    <sql id="search">
        <if test="searchType != null">
            <if test="searchType == 't'.toString()">
                and title like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType == 'c'.toString()">
                and content like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType == 'w'.toString()">
                and writer like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="searchType == 'tc'.toString()">
                and ( title like CONCAT('%', #{keyword}, '%') OR content like CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="searchType == 'cw'.toString()">
                and ( content like CONCAT('%', #{keyword}, '%') OR writer like CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="searchType == 'tcw'.toString()">
                and ( title like CONCAT('%', #{keyword}, '%')
                OR
                content like CONCAT('%', #{keyword}, '%')
                OR
                writer like CONCAT('%', #{keyword}, '%'))
            </if>
        </if>
    </sql>

    <select id="listSearch" resultType="BoardVO">
        <![CDATA[
          select *
          from tbl_board
          where bno > 0
        ]]>

        <include refid="search"></include>

        <![CDATA[
          order by bno desc
          limit #{pageStart}, #{perPageNum}
        ]]>
    </select>

    <select id="listSearchCount" resultType="int">
        <![CDATA[
          select count(bno)
          from tbl_board
          where bno > 0
        ]]>

        <include refid="search"></include>

    </select>


    <update id="updateReplyCnt">
        UPDATE tbl_board SET replycnt = replycnt + #{amount} WHERE bno = #{bno}
    </update>


    <update id="updateViewCnt">
        UPDATE tbl_board SET viewcnt = viewcnt + 1 WHERE bno = #{bno}
    </update>


    <insert id="addAttach">
        INSERT INTO tbl_attach(fullname, bno) VALUES (#{fullName}, LAST_INSERT_ID())
    </insert>


    <select id="getAttach" resultType="string">
        SELECT fullname FROM tbl_attach WHERE bno = #{bno} ORDER BY regdate
    </select>


    <delete id="deleteAttach">
        DELETE FROM tbl_attach WHERE bno = #{bno}
    </delete>

    <insert id="replaceAttach">
        INSERT INTO tbl_attach(fullname, bno) VALUES (#{fullName}, #{bno})
    </insert>


</mapper>
